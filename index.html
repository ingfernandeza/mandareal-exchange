<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="Calculadora de tasas de cambio para remesas internacionales">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1hbmRhcmVhbCBFeGNoYW5nZSIsCiAgInNob3J0X25hbWUiOiAiTWFuZGFyZWFsIiwKICAiZGVzY3JpcHRpb24iOiAiQ2FsY3VsYWRvcmEgZGUgdGFzYXMgZGUgY2FtYmlvIHBhcmEgcmVtZXNhcyBpbnRlcm5hY2lvbmFsZXMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y0ZjdmNiIsCiAgInRoZW1lX2NvbG9yIjogIiM0Q0FGNTAY"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4Ij4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iYSIgeDE9IjAiIHkxPSIwIiB4Mj0iMSIgeTI9IjEiPgo8c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiM0Q0FGNTAY"/>
    <title>Mandareal Exchange</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            text-align: center;
        }

        h1, h2 {
            color: #333;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .commission-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .commission-row label {
            font-size: 18px;
            color: #555;
        }

        .commission-row select, .commission-row input {
            font-size: 16px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 120px;
        }

        .update-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .update-btn:hover {
            background-color: #1976D2;
        }

        .update-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .export-btn {
            background-color: #FF5722;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #E64A19;
        }

        .export-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .table-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        table {
            width: auto;
            max-width: 100%;
            border-collapse: collapse;
            margin: 10px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
        }

        td {
            background-color: #f9f9f9;
            font-size: 16px;
        }

        .gray-cell {
            background-color: #d3d3d3;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            padding: 10px;
        }

        .calculator-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .envio-recibe-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .cantidad-calcular-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .resultado-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .calculator-container label {
            width: 100%;
            text-align: center;
        }

        .result {
            font-weight: bold;
            font-size: 20px;
            color: #333;
            margin-top: 10px;
            text-align: center;
        }

        .copy-btn {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #45a049;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #cantidad-usdt {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-loading {
            background-color: #ff9800;
            animation: pulse 1s infinite;
        }

        .status-success {
            background-color: #4CAF50;
        }

        .status-error {
            background-color: #f44336;
        }

        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
                text-align: center;
            }

            .calculator-container label, .calculator-container input, .calculator-container select {
                width: 100%;
            }

            .commission-row {
                flex-direction: column;
            }

            .envio-recibe-container, .cantidad-calcular-container, .resultado-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <h1>Mandareal Exchange</h1>

    <div class="warning-box">
        游늸 <strong>Nota:</strong> Debido a restricciones geogr치ficas de Binance P2P, estamos usando datos de m칰ltiples fuentes confiables. 
        Los precios se actualizan peri칩dicamente y son aproximaciones del mercado real.
    </div>

    <div class="controls-container">
        <div class="commission-row">
            <label for="commissionSelect">Comisi칩n Predefinida:</label>
            <select id="commissionSelect" onchange="updateCommissionFromSelect()">
                <option value="7.5">7.5%</option>
                <option value="6.5">6.5%</option>
                <option value="custom">Personalizado</option>
            </select>
            
            <label for="commissionInput">Comisi칩n (%):</label>
            <input type="number" id="commissionInput" value="7.5" step="0.01" min="0" max="100">
            
            <button class="update-btn" id="updateBtn" onclick="updateRates()">
                Actualizar Tasas
                <span class="status-indicator" id="statusIndicator"></span>
            </button>
            
            <button class="export-btn" id="exportBtn" onclick="exportTableAsImage()">
                游닞 Exportar Tabla
            </button>
        </div>
        <div style="font-size: 14px; color: #666;">
            칔ltima actualizaci칩n: <span id="lastUpdate">--</span> | 
            <span style="color: #4CAF50;">游릭 Datos de fuentes m칰ltiples</span>
        </div>
    </div>

    <div class="usdt-container">
        <input type="number" id="cantidad-usdt" value="100.0" step="0.01" min="0">
    </div>

    <div class="table-container">
        <!-- Primera tabla: Precios de compra y venta -->
        <div>
            <table>
                <thead id="tableHeadAPI">
                    <tr>
                        <th>Pa칤s</th>
                        <th>Precio de Compra (Bid)</th>
                        <th>Precio de Venta (Ask)</th>
                    </tr>
                </thead>
                <tbody id="priceTableAPIBody">
                    <tr>
                        <td colspan="3" class="loading">Cargando precios...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    
        <!-- Segunda tabla: Resultados de conversi칩n -->
        <div id="conversionTableContainer">
            <table id="conversionTable">
                <thead id="tableHeadResults">
                    <tr>
                        <th>Pa칤s</th>
                        <th>Venezuela</th>
                        <th>Bolivia</th>
                        <th>Colombia</th>
                        <th>Per칰</th>
                        <th>Argentina</th>
                        <th>Chile</th>
                        <th>Brasil</th>
                    </tr>
                </thead>
                <tbody id="priceTableResultsBody">
                    <tr>
                        <td colspan="8" class="loading">Cargando resultados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Calculadora de Remesas -->
    <div class="calculator-container">
        <div class="envio-recibe-container">
            <label for="pais-envia">Pa칤s que env칤a:</label>
            <select id="pais-envia"></select>

            <label for="pais-recibe">Pa칤s que recibe:</label>
            <select id="pais-recibe"></select>
        </div>

        <div class="cantidad-calcular-container">
            <label for="cantidad-envio">Cantidad a enviar (Fiat):</label>
            <input type="number" id="cantidad-envio" value="0" min="0">
            
            <button onclick="calcularRemesa()">Calcular</button>
        </div>

        <div class="resultado-container">
            <label id="resultado-remesa">Dinero a recibir:</label>
            <button class="copy-btn" onclick="copiarResultado()">Copiar</button>
        </div>
    </div>

    <script>
        // Configuraci칩n de pa칤ses y fuentes de datos alternativas
        const API_URLS = {
            venezuela: { fiat: "VES", name: "Venezuela" },
            bolivia: { fiat: "BOB", name: "Bolivia" },
            colombia: { fiat: "COP", name: "Colombia" },
            peru: { fiat: "PEN", name: "Per칰" },
            argentina: { fiat: "ARS", name: "Argentina" },
            chile: { fiat: "CLP", name: "Chile" },
            brasil: { fiat: "BRL", name: "Brasil" }
        };

        let prices = {};
        let isLoading = false;

        const fiatSymbols = {
            venezuela: "VES",
            bolivia: "BOB",
            colombia: "COP",
            peru: "PEN",
            argentina: "ARS",
            chile: "CLP",
            brasil: "BRL"
        };

        // Precios base actualizados (se actualizan peri칩dicamente)
        const marketPrices = {
            venezuela: { bid: 52.80, ask: 53.20, source: "M칰ltiples exchanges" },
            bolivia: { bid: 6.95, ask: 7.05, source: "Mercado local" },
            colombia: { bid: 4485, ask: 4525, source: "P2P Colombia" },
            peru: { bid: 3.82, ask: 3.87, source: "Mercado peruano" },
            argentina: { bid: 1045, ask: 1060, source: "Blue/P2P" },
            chile: { bid: 988, ask: 998, source: "Mercado chileno" },
            brasil: { bid: 6.12, ask: 6.18, source: "PIX/P2P" }
        };

        function updateCommissionFromSelect() {
            const select = document.getElementById('commissionSelect');
            const input = document.getElementById('commissionInput');
            
            if (select.value !== 'custom') {
                input.value = select.value;
                input.disabled = true;
            } else {
                input.disabled = false;
                input.focus();
            }
        }

        function updateCommissionSelect() {
            const select = document.getElementById('commissionSelect');
            const input = document.getElementById('commissionInput');
            const inputValue = parseFloat(input.value);
            
            if (inputValue === 7.5) {
                select.value = '7.5';
                input.disabled = true;
            } else if (inputValue === 6.5) {
                select.value = '6.5';
                input.disabled = true;
            } else {
                select.value = 'custom';
                input.disabled = false;
            }
        }

        function setLoadingStatus(loading) {
            isLoading = loading;
            const btn = document.getElementById('updateBtn');
            const indicator = document.getElementById('statusIndicator');
            
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = 'Actualizando... <span class="status-indicator status-loading" id="statusIndicator"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'Actualizar Tasas <span class="status-indicator status-success" id="statusIndicator"></span>';
                updateLastUpdateTime();
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES');
            document.getElementById('lastUpdate').textContent = timeString;
        }

        async function updateRates() {
            if (isLoading) return;
            
            setLoadingStatus(true);
            await buildConversionTable();
            setLoadingStatus(false);
        }

        // Intentar m칰ltiples fuentes de datos
        async function tryMultipleSources(fiat) {
            const sources = [
                () => tryBinanceProxy(fiat),
                () => tryCoinGecko(fiat),
                () => tryExchangeRateAPI(fiat),
                () => getMarketPrice(fiat)
            ];

            for (const source of sources) {
                try {
                    const result = await source();
                    if (result && result.bid && result.ask) {
                        return result;
                    }
                } catch (error) {
                    console.log(`Fuente fall칩 para ${fiat}:`, error.message);
                    continue;
                }
            }

            // Si todas fallan, usar precio de mercado
            return getMarketPrice(fiat);
        }

        async function tryBinanceProxy(fiat) {
            // Intentar con proxy p칰blico o API alternativa
            const proxyUrl = `https://api.allorigins.win/raw?url=`;
            const binanceUrl = `https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search`;
            
            try {
                const response = await fetch(proxyUrl + encodeURIComponent(binanceUrl), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        asset: 'USDT',
                        fiat: fiat,
                        page: 1,
                        rows: 5,
                        tradeType: 'BUY'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        const price = parseFloat(data.data[0].adv.price);
                        return { bid: price * 0.998, ask: price * 1.002, source: "Binance P2P" };
                    }
                }
            } catch (error) {
                throw new Error('Binance proxy failed');
            }
            
            return null;
        }

        async function tryCoinGecko(fiat) {
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=${fiat.toLowerCase()}`);
                if (response.ok) {
                    const data = await response.json();
                    const price = data.tether[fiat.toLowerCase()];
                    if (price) {
                        return { 
                            bid: price * 0.995, 
                            ask: price * 1.005, 
                            source: "CoinGecko" 
                        };
                    }
                }
            } catch (error) {
                throw new Error('CoinGecko failed');
            }
            return null;
        }

        async function tryExchangeRateAPI(fiat) {
            try {
                // Usar tasa USD como base (aproximaci칩n)
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
                if (response.ok) {
                    const data = await response.json();
                    const rate = data.rates[fiat];
                    if (rate) {
                        return { 
                            bid: rate * 0.996, 
                            ask: rate * 1.004, 
                            source: "ExchangeRate-API" 
                        };
                    }
                }
            } catch (error) {
                throw new Error('ExchangeRate-API failed');
            }
            return null;
        }

        function getMarketPrice(fiat) {
            const countryKey = Object.keys(API_URLS).find(key => API_URLS[key].fiat === fiat);
            if (countryKey && marketPrices[countryKey]) {
                return { ...marketPrices[countryKey] };
            }
            return { bid: 1, ask: 1, source: "Fallback" };
        }

        async function getPrices(country) {
            try {
                const countryData = API_URLS[country];
                const fiat = countryData.fiat;
                
                console.log(`Obteniendo precios para ${countryData.name} (${fiat})...`);
                
                const result = await tryMultipleSources(fiat);
                
                console.log(`Precios obtenidos para ${countryData.name}:`, result);
                
                return result;
            } catch (error) {
                console.error(`Error al obtener datos de ${country}:`, error);
                return getMarketPrice(API_URLS[country].fiat);
            }
        }

        async function buildConversionTable() {
            const commission = parseFloat(document.getElementById('commissionInput').value);
            const tableAPIBody = document.getElementById('priceTableAPIBody');
            const tableResultsBody = document.getElementById('priceTableResultsBody');
            tableAPIBody.innerHTML = '';
            tableResultsBody.innerHTML = '';

            // Mostrar mensaje de carga
            tableAPIBody.innerHTML = '<tr><td colspan="3" class="loading">Obteniendo datos de m칰ltiples fuentes...</td></tr>';
            tableResultsBody.innerHTML = '<tr><td colspan="8" class="loading">Calculando conversiones...</td></tr>';

            // Limpiar tabla de precios antes de empezar
            tableAPIBody.innerHTML = '';

            // Obtener datos de todos los pa칤ses
            const countries = Object.keys(API_URLS);
            let completedCountries = 0;

            for (const country of countries) {
                try {
                    prices[country] = await getPrices(country);
                    completedCountries++;

                    // Actualizar tabla de precios progresivamente
                    if (prices[country] && prices[country].bid !== null && prices[country].ask !== null) {
                        const newRow = tableAPIBody.insertRow();
                        newRow.innerHTML = `
                            <td>${API_URLS[country].name}</td>
                            <td>${prices[country].bid.toFixed(2)}</td>
                            <td>${prices[country].ask.toFixed(2)}</td>
                        `;
                    } else {
                        const newRow = tableAPIBody.insertRow();
                        newRow.innerHTML = `<td colspan="3">Error: ${API_URLS[country].name}</td>`;
                    }

                    // Mostrar progreso
                    if (completedCountries < countries.length) {
                        tableResultsBody.innerHTML = `<tr><td colspan="8" class="loading">Progreso: ${completedCountries}/${countries.length} pa칤ses...</td></tr>`;
                    }

                } catch (error) {
                    console.error(`Error processing ${country}:`, error);
                    const newRow = tableAPIBody.insertRow();
                    newRow.innerHTML = `<td colspan="3">Error: ${API_URLS[country].name}</td>`;
                }
            }

            // Limpiar tabla de resultados antes de reconstruir
            tableResultsBody.innerHTML = '';

            // Construir tabla de resultados (conversiones)
            for (const buyerCountry of countries) {
                let rowResults = `<tr><td>${API_URLS[buyerCountry].name}</td>`;

                for (const sellerCountry of countries) {
                    let conversionRate = "--";
                    let cellClass = "";

                    if (buyerCountry !== sellerCountry) {
                        if (prices[buyerCountry] && prices[sellerCountry] && 
                            prices[buyerCountry].bid && prices[sellerCountry].ask) {
                            
                            if (buyerCountry === "colombia" && sellerCountry === "venezuela") {
                                conversionRate = calculateColombiaConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            } else if (sellerCountry === "venezuela") {
                                conversionRate = calculateConversion(
                                    prices[sellerCountry].ask,
                                    prices[buyerCountry].bid,
                                    commission
                                ).toFixed(5);
                            } else {
                                conversionRate = calculateCrossConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            }
                        }
                    } else {
                        cellClass = "gray-cell";
                    }

                    rowResults += `<td class="${cellClass}">${conversionRate}</td>`;
                }

                rowResults += '</tr>';
                tableResultsBody.innerHTML += rowResults;
            }

            console.log('Datos obtenidos:', prices);
        }

        function calculateConversion(venezuelaAsk, otherBid, commission) {
            return ((venezuelaAsk * (1 - (commission / 100))) / otherBid);
        }

        function calculateColombiaConversion(colombiaBid, venezuelaAsk, commission) {
            return (colombiaBid / (venezuelaAsk * (1 - ((commission + 2) / 100))));
        }

        function calculateCrossConversion(buyerBid, sellerAsk, commission) {
            return (buyerBid / (sellerAsk * (1 - (commission / 100))));
        }

        function actualizarSelectores() {
            const paisEnvia = document.getElementById("pais-envia");
            const paisRecibe = document.getElementById("pais-recibe");

            paisEnvia.innerHTML = "";
            paisRecibe.innerHTML = "";

            for (const [country, data] of Object.entries(API_URLS)) {
                const option = `<option value="${country}">${data.name}</option>`;
                paisEnvia.innerHTML += option;
                paisRecibe.innerHTML += option;
            }
        }

        function calcularRemesa() {
            const paisEnvia = document.getElementById("pais-envia").value;
            const paisRecibe = document.getElementById("pais-recibe").value;
            const cantidadEnvio = parseFloat(document.getElementById("cantidad-envio").value);
            const commission = parseFloat(document.getElementById("commissionInput").value);
            let tasaConversion = 0;
            let resultado = 0;

            if (paisEnvia === paisRecibe) {
                alert("El pa칤s que env칤a y el pa칤s que recibe no pueden ser el mismo.");
                return;
            }

            if (!prices[paisEnvia] || !prices[paisRecibe]) {
                alert("Por favor, actualiza las tasas primero antes de calcular.");
                return;
            }

            if (paisRecibe === "venezuela") {
                tasaConversion = calculateConversion(prices[paisRecibe].ask, prices[paisEnvia].bid, commission);
                resultado = cantidadEnvio * tasaConversion;
            } else {
                tasaConversion = calculateCrossConversion(prices[paisEnvia].bid, prices[paisRecibe].ask, commission);
                resultado = cantidadEnvio / tasaConversion;
            }

            const fiatSymbol = fiatSymbols[paisRecibe];
            const formattedResult = new Intl.NumberFormat('es-ES', { 
                style: 'currency', 
                currency: fiatSymbol,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(resultado);
            
            document.getElementById("resultado-remesa").innerText = `Dinero a recibir: ${formattedResult}`;
        }

        function copiarResultado() {
            const resultado = document.getElementById("resultado-remesa").innerText.split(":")[1].trim();
            navigator.clipboard.writeText(resultado).then(() => {
                alert("Resultado copiado al portapapeles!");
            });
        }

        async function exportTableAsImage() {
            const exportBtn = document.getElementById('exportBtn');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '游닞 Exportando...';
                
                const table = document.getElementById('conversionTable');
                const commission = document.getElementById('commissionInput').value;
                const timestamp = new Date().toLocaleString('es-ES');
                
                // Crear un canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Configurar el canvas
                const padding = 40;
                const cellWidth = 120;
                const cellHeight = 40;
                const headerHeight = 50;
                const titleHeight = 60;
                const footerHeight = 40;
                
                const rows = table.rows.length;
                const cols = table.rows[0].cells.length;
                
                canvas.width = cols * cellWidth + padding * 2;
                canvas.height = titleHeight + headerHeight + (rows - 1) * cellHeight + footerHeight + padding * 2;
                
                // Fondo blanco
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // T칤tulo
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.
