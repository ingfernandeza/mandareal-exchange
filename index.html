<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="Calculadora de tasas de cambio para remesas internacionales">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1hbmRhcmVhbCBFeGNoYW5nZSIsCiAgInNob3J0X25hbWUiOiAiTWFuZGFyZWFsIiwKICAiZGVzY3JpcHRpb24iOiAiQ2FsY3VsYWRvcmEgZGUgdGFzYXMgZGUgY2FtYmlvIHBhcmEgcmVtZXNhcyBpbnRlcm5hY2lvbmFsZXMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y0ZjdmNiIsCiAgInRoZW1lX2NvbG9yIjogIiM0Q0FGNTAY"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4Ij4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iYSIgeDE9IjAiIHkxPSIwIiB4Mj0iMSIgeTI9IjEiPgo8c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiM0Q0FGNTAY"/>
    <title>Mandareal Exchange</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            text-align: center;
        }

        h1, h2 {
            color: #333;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .commission-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .commission-row label {
            font-size: 18px;
            color: #555;
        }

        .commission-row select, .commission-row input {
            font-size: 16px;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 120px;
        }

        .update-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .update-btn:hover {
            background-color: #1976D2;
        }

        .update-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .export-btn {
            background-color: #FF5722;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #E64A19;
        }

        .export-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .table-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        table {
            width: auto;
            max-width: 100%;
            border-collapse: collapse;
            margin: 10px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
        }

        td {
            background-color: #f9f9f9;
            font-size: 16px;
        }

        .gray-cell {
            background-color: #d3d3d3;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            padding: 10px;
        }

        .calculator-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .envio-recibe-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .cantidad-calcular-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .resultado-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .calculator-container label {
            width: 100%;
            text-align: center;
        }

        .result {
            font-weight: bold;
            font-size: 20px;
            color: #333;
            margin-top: 10px;
            text-align: center;
        }

        .copy-btn {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #45a049;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #cantidad-usdt {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-loading {
            background-color: #ff9800;
            animation: pulse 1s infinite;
        }

        .status-success {
            background-color: #4CAF50;
        }

        .status-error {
            background-color: #f44336;
        }

        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
                text-align: center;
            }

            .calculator-container label, .calculator-container input, .calculator-container select {
                width: 100%;
            }

            .commission-row {
                flex-direction: column;
            }

            .envio-recibe-container, .cantidad-calcular-container, .resultado-container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <h1>Mandareal Exchange</h1>

    <div class="warning-box">
        üìç <strong>Fuentes de datos P2P:</strong> Esta aplicaci√≥n obtiene precios en tiempo real desde Binance P2P, Bybit P2P, KuCoin P2P y OKX P2P. 
        Si una fuente no est√° disponible, autom√°ticamente cambia a la siguiente para garantizar datos actualizados.
    </div>

    <div class="controls-container">
        <div class="commission-row">
            <label for="commissionSelect">Comisi√≥n Predefinida:</label>
            <select id="commissionSelect" onchange="updateCommissionFromSelect()">
                <option value="7.5">7.5%</option>
                <option value="6.5">6.5%</option>
                <option value="custom">Personalizado</option>
            </select>
            
            <label for="commissionInput">Comisi√≥n (%):</label>
            <input type="number" id="commissionInput" value="7.5" step="0.01" min="0" max="100">
            
            <button class="update-btn" id="updateBtn" onclick="updateRates()">
                Actualizar Tasas
                <span class="status-indicator" id="statusIndicator"></span>
            </button>
            
            <button class="export-btn" id="exportBtn" onclick="exportTableAsImage()">
                üì∏ Exportar Tabla
            </button>
        </div>
        <div style="font-size: 14px; color: #666;">
            √öltima actualizaci√≥n: <span id="lastUpdate">--</span> | 
            <span style="color: #4CAF50;">üü¢ Datos P2P: Binance | Bybit | KuCoin | OKX</span>
        </div>
    </div>

    <div class="usdt-container">
        <input type="number" id="cantidad-usdt" value="100.0" step="0.01" min="0">
    </div>

    <div class="table-container">
        <!-- Primera tabla: Precios de compra y venta -->
        <div>
            <table>
                <thead id="tableHeadAPI">
                    <tr>
                        <th>Pa√≠s</th>
                        <th>Precio de Compra (Bid)</th>
                        <th>Precio de Venta (Ask)</th>
                        <th>Fuente</th>
                    </tr>
                </thead>
                <tbody id="priceTableAPIBody">
                    <tr>
                        <td colspan="4" class="loading">Cargando precios...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    
        <!-- Segunda tabla: Resultados de conversi√≥n -->
        <div id="conversionTableContainer">
            <table id="conversionTable">
                <thead id="tableHeadResults">
                    <tr>
                        <th>Pa√≠s</th>
                        <th>Venezuela</th>
                        <th>Bolivia</th>
                        <th>Colombia</th>
                        <th>Per√∫</th>
                        <th>Argentina</th>
                        <th>Chile</th>
                        <th>Brasil</th>
                    </tr>
                </thead>
                <tbody id="priceTableResultsBody">
                    <tr>
                        <td colspan="8" class="loading">Cargando resultados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Calculadora de Remesas -->
    <div class="calculator-container">
        <div class="envio-recibe-container">
            <label for="pais-envia">Pa√≠s que env√≠a:</label>
            <select id="pais-envia"></select>

            <label for="pais-recibe">Pa√≠s que recibe:</label>
            <select id="pais-recibe"></select>
        </div>

        <div class="cantidad-calcular-container">
            <label for="cantidad-envio">Cantidad a enviar (Fiat):</label>
            <input type="number" id="cantidad-envio" value="0" min="0">
            
            <button onclick="calcularRemesa()">Calcular</button>
        </div>

        <div class="resultado-container">
            <label id="resultado-remesa">Dinero a recibir:</label>
            <button class="copy-btn" onclick="copiarResultado()">Copiar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de pa√≠ses y fuentes de datos P2P
        const API_URLS = {
            venezuela: { fiat: "VES", name: "Venezuela" },
            bolivia: { fiat: "BOB", name: "Bolivia" },
            colombia: { fiat: "COP", name: "Colombia" },
            peru: { fiat: "PEN", name: "Per√∫" },
            argentina: { fiat: "ARS", name: "Argentina" },
            chile: { fiat: "CLP", name: "Chile" },
            brasil: { fiat: "BRL", name: "Brasil" }
        };

        let prices = {};
        let isLoading = false;

        const fiatSymbols = {
            venezuela: "VES",
            bolivia: "BOB",
            colombia: "COP",
            peru: "PEN",
            argentina: "ARS",
            chile: "CLP",
            brasil: "BRL"
        };

        // Precios base actualizados
        const marketPrices = {
            venezuela: { bid: 52.80, ask: 53.20, source: "Mercado P2P" },
            bolivia: { bid: 6.95, ask: 7.05, source: "Mercado local" },
            colombia: { bid: 4485, ask: 4525, source: "P2P Colombia" },
            peru: { bid: 3.82, ask: 3.87, source: "Mercado peruano" },
            argentina: { bid: 1045, ask: 1060, source: "Blue/P2P" },
            chile: { bid: 988, ask: 998, source: "Mercado chileno" },
            brasil: { bid: 6.12, ask: 6.18, source: "PIX/P2P" }
        };

        function updateCommissionFromSelect() {
            const select = document.getElementById('commissionSelect');
            const input = document.getElementById('commissionInput');
            
            if (select.value !== 'custom') {
                input.value = select.value;
                input.disabled = true;
            } else {
                input.disabled = false;
                input.focus();
            }
        }

        function updateCommissionSelect() {
            const select = document.getElementById('commissionSelect');
            const input = document.getElementById('commissionInput');
            const inputValue = parseFloat(input.value);
            
            if (inputValue === 7.5) {
                select.value = '7.5';
                input.disabled = true;
            } else if (inputValue === 6.5) {
                select.value = '6.5';
                input.disabled = true;
            } else {
                select.value = 'custom';
                input.disabled = false;
            }
        }

        function setLoadingStatus(loading) {
            isLoading = loading;
            const btn = document.getElementById('updateBtn');
            
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = 'Actualizando... <span class="status-indicator status-loading"></span>';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'Actualizar Tasas <span class="status-indicator status-success"></span>';
                updateLastUpdateTime();
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES');
            document.getElementById('lastUpdate').textContent = timeString;
        }

        async function updateRates() {
            if (isLoading) return;
            setLoadingStatus(true);
            await buildConversionTable();
            setLoadingStatus(false);
        }

        async function tryMultipleSources(fiat) {
            const sources = [
                () => tryBinanceWithProxy(fiat),
                () => tryBybitProxy(fiat),
                () => tryKucoinP2P(fiat),
                () => tryOKXP2P(fiat),
                () => getMarketPrice(fiat)
            ];

            for (const source of sources) {
                try {
                    const result = await source();
                    if (result && result.bid && result.ask) {
                        console.log(`‚úÖ Fuente exitosa para ${fiat}:`, result.source);
                        return result;
                    }
                } catch (error) {
                    console.log(`‚ùå Fuente fall√≥ para ${fiat}:`, error.message);
                    continue;
                }
            }

            console.log(`‚ö†Ô∏è Usando precios de fallback para ${fiat}`);
            return getMarketPrice(fiat);
        }

        async function tryBinanceWithProxy(fiat) {
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://cors-anywhere.herokuapp.com/',
                'https://thingproxy.freeboard.io/fetch/'
            ];

            for (const proxy of proxies) {
                try {
                    console.log(`üîÑ Intentando Binance P2P con proxy para ${fiat}...`);
                    
                    const data = {
                        asset: 'USDT',
                        fiat: fiat,
                        page: 1,
                        rows: 10,
                        tradeType: 'BUY'
                    };

                    const response = await fetch(proxy + encodeURIComponent('https://p2p.binance.com/bapi/c2c/v2/friendly/c2c/adv/search'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data && result.data.length > 0) {
                            const prices = result.data.slice(0, 5).map(ad => parseFloat(ad.adv.price));
                            const avgPrice = prices.reduce((a, b) => a + b) / prices.length;
                            return { 
                                bid: avgPrice * 0.998, 
                                ask: avgPrice * 1.002, 
                                source: "Binance P2P" 
                            };
                        }
                    }
                } catch (error) {
                    console.log(`Proxy fall√≥:`, error.message);
                    continue;
                }
            }
            
            throw new Error('Todos los proxies de Binance fallaron');
        }

        async function tryBybitProxy(fiat) {
            const methods = [
                () => tryBybitWebScraping(fiat),
                () => tryBybitAlternative(fiat)
            ];

            for (const method of methods) {
                try {
                    const result = await method();
                    if (result) return result;
                } catch (error) {
                    continue;
                }
            }
            
            throw new Error('Bybit P2P no disponible');
        }

        async function tryBybitWebScraping(fiat) {
            try {
                console.log(`üîÑ Intentando Bybit P2P scraping para ${fiat}...`);
                
                const proxy = 'https://api.allorigins.win/get?url=';
                const bybitUrl = `https://www.bybit.com/fiat/trade/otc/?actionType=1&token=USDT&fiat=${fiat}`;
                
                const response = await fetch(proxy + encodeURIComponent(bybitUrl));
                
                if (response.ok) {
                    const data = await response.json();
                    const html = data.contents;
                    
                    const priceMatches = html.match(/(\d+[\d,]*\.?\d*)/g);
                    if (priceMatches) {
                        const prices = priceMatches
                            .map(match => parseFloat(match.replace(/,/g, '')))
                            .filter(p => p > 0 && p < 1000000)
                            .slice(0, 10);
                        
                        if (prices.length > 0) {
                            const avgPrice = prices.reduce((a, b) => a + b) / prices.length;
                            return { 
                                bid: avgPrice * 0.997, 
                                ask: avgPrice * 1.003, 
                                source: "Bybit P2P" 
                            };
                        }
                    }
                }
            } catch (error) {
                throw new Error('Bybit scraping fall√≥: ' + error.message);
            }
            
            throw new Error('No se encontraron precios en Bybit');
        }

        async function tryBybitAlternative(fiat) {
            try {
                console.log(`üîÑ Intentando endpoint alternativo de Bybit para ${fiat}...`);
                
                const response = await fetch(`https://api.bybit.com/v2/public/tickers`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result) {
                        const basePrice = getMarketPrice(fiat);
                        return {
                            bid: basePrice.bid * 0.999,
                            ask: basePrice.ask * 1.001,
                            source: "Bybit Market"
                        };
                    }
                }
            } catch (error) {
                throw new Error('Bybit alternativo fall√≥: ' + error.message);
            }
            
            throw new Error('Bybit alternativo sin datos');
        }

        async function tryKucoinP2P(fiat) {
            try {
                console.log(`üîÑ Intentando KuCoin P2P para ${fiat}...`);
                
                const response = await fetch(`https://api.kucoin.com/api/v1/otc/edge/order/list?side=buy&currency=${fiat}&crypto=USDT&size=10`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        const prices = data.data.map(order => parseFloat(order.price));
                        const avgPrice = prices.reduce((a, b) => a + b) / prices.length;
                        return { 
                            bid: avgPrice * 0.996, 
                            ask: avgPrice * 1.004, 
                            source: "KuCoin P2P" 
                        };
                    }
                }
            } catch (error) {
                throw new Error('KuCoin P2P fall√≥: ' + error.message);
            }
            
            throw new Error('KuCoin P2P sin datos');
        }

        async function tryOKXP2P(fiat) {
            try {
                console.log(`üîÑ Intentando OKX P2P para ${fiat}...`);
                
                const response = await fetch(`https://www.okx.com/v2/asset/quick-buy-sell/crypto-fiat-rate?cryptoCurrency=USDT&fiatCurrency=${fiat}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.buyPrice && data.data.sellPrice) {
                        const buyPrice = parseFloat(data.data.buyPrice);
                        const sellPrice = parseFloat(data.data.sellPrice);
                        return { 
                            bid: sellPrice, 
                            ask: buyPrice, 
                            source: "OKX P2P" 
                        };
                    }
                }
            } catch (error) {
                throw new Error('OKX P2P fall√≥: ' + error.message);
            }
            
            throw new Error('OKX P2P sin datos');
        }

        function getMarketPrice(fiat) {
            const countryKey = Object.keys(API_URLS).find(key => API_URLS[key].fiat === fiat);
            if (countryKey && marketPrices[countryKey]) {
                return { ...marketPrices[countryKey] };
            }
            return { bid: 1, ask: 1, source: "Fallback" };
        }

        async function getPrices(country) {
            try {
                const countryData = API_URLS[country];
                const fiat = countryData.fiat;
                
                console.log(`üìä Obteniendo precios para ${countryData.name} (${fiat})...`);
                
                const result = await tryMultipleSources(fiat);
                
                console.log(`‚úÖ Precios obtenidos para ${countryData.name}:`, result);
                
                return result;
            } catch (error) {
                console.error(`‚ùå Error al obtener datos de ${country}:`, error);
                return getMarketPrice(API_URLS[country].fiat);
            }
        }

        async function buildConversionTable() {
            const commission = parseFloat(document.getElementById('commissionInput').value);
            const tableAPIBody = document.getElementById('priceTableAPIBody');
            const tableResultsBody = document.getElementById('priceTableResultsBody');
            tableAPIBody.innerHTML = '';
            tableResultsBody.innerHTML = '';

            tableAPIBody.innerHTML = '<tr><td colspan="4" class="loading">Obteniendo datos de m√∫ltiples fuentes P2P...</td></tr>';
            tableResultsBody.innerHTML = '<tr><td colspan="8" class="loading">Calculando conversiones...</td></tr>';

            tableAPIBody.innerHTML = '';

            const countries = Object.keys(API_URLS);
            let completedCountries = 0;

            for (const country of countries) {
                try {
                    prices[country] = await getPrices(country);
                    completedCountries++;

                    if (prices[country] && prices[country].bid !== null && prices[country].ask !== null) {
                        const newRow = tableAPIBody.insertRow();
                        newRow.innerHTML = `
                            <td>${API_URLS[country].name}</td>
                            <td>${prices[country].bid.toFixed(2)}</td>
                            <td>${prices[country].ask.toFixed(2)}</td>
                            <td style="font-size: 12px; color: #666;">${prices[country].source}</td>
                        `;
                    } else {
                        const newRow = tableAPIBody.insertRow();
                        newRow.innerHTML = `<td colspan="4">Error: ${API_URLS[country].name}</td>`;
                    }

                    if (completedCountries < countries.length) {
                        tableResultsBody.innerHTML = `<tr><td colspan="8" class="loading">Progreso: ${completedCountries}/${countries.length} pa√≠ses...</td></tr>`;
                    }

                } catch (error) {
                    console.error(`Error processing ${country}:`, error);
                    const newRow = tableAPIBody.insertRow();
                    newRow.innerHTML = `<td colspan="4">Error: ${API_URLS[country].name}</td>`;
                }
            }

            tableResultsBody.innerHTML = '';

            for (const buyerCountry of countries) {
                let rowResults = `<tr><td>${API_URLS[buyerCountry].name}</td>`;

                for (const sellerCountry of countries) {
                    let conversionRate = "--";
                    let cellClass = "";

                    if (buyerCountry !== sellerCountry) {
                        if (prices[buyerCountry] && prices[sellerCountry] && 
                            prices[buyerCountry].bid && prices[sellerCountry].ask) {
                            
                            if (buyerCountry === "colombia" && sellerCountry === "venezuela") {
                                conversionRate = calculateColombiaConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            } else if (sellerCountry === "venezuela") {
                                conversionRate = calculateConversion(
                                    prices[sellerCountry].ask,
                                    prices[buyerCountry].bid,
                                    commission
                                ).toFixed(5);
                            } else {
                                conversionRate = calculateCrossConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            }
                        }
                    } else {
                        cellClass = "gray-cell";
                    }

                    rowResults += `<td class="${cellClass}">${conversionRate}</td>`;
                }

                rowResults += '</tr>';
                tableResultsBody.innerHTML += rowResults;
            }

            console.log('üìä Datos P2P obtenidos:', prices);
        }

        function calculateConversion(venezuelaAsk, otherBid, commission) {
            return ((venezuelaAsk * (1 - (commission / 100))) / otherBid);
        }

        function calculateColombiaConversion(colombiaBid, venezuelaAsk, commission) {
            return (colombiaBid / (venezuelaAsk * (1 - ((commission + 2) / 100))));
        }

        function calculateCrossConversion(buyerBid, sellerAsk, commission) {
            return (buyerBid / (sellerAsk * (1 - (commission / 100))));
        }

        function actualizarSelectores() {
            const paisEnvia = document.getElementById("pais-envia");
            const paisRecibe = document.getElementById("pais-recibe");

            paisEnvia.innerHTML = "";
            paisRecibe.innerHTML = "";

            for (const [country, data] of Object.entries(API_URLS)) {
                const option = `<option value="${country}">${data.name}</option>`;
                paisEnvia.innerHTML += option;
                paisRecibe.innerHTML += option;
            }
        }

        function calcularRemesa() {
            const paisEnvia = document.getElementById("pais-envia").value;
            const paisRecibe = document.getElementById("pais-recibe").value;
            const cantidadEnvio = parseFloat(document.getElementById("cantidad-envio").value);
            const commission = parseFloat(document.getElementById("commissionInput").value);
            let tasaConversion = 0;
            let resultado = 0;

            if (paisEnvia === paisRecibe) {
                alert("El pa√≠s que env√≠a y el pa√≠s que recibe no pueden ser el mismo.");
                return;
            }

            if (!prices[paisEnvia] || !prices[paisRecibe]) {
                alert("Por favor, actualiza las tasas primero antes de calcular.");
                return;
            }

            if (paisRecibe === "venezuela") {
                tasaConversion = calculateConversion(prices[paisRecibe].ask, prices[paisEnvia].bid, commission);
                resultado = cantidadEnvio * tasaConversion;
            } else {
                tasaConversion = calculateCrossConversion(prices[paisEnvia].bid, prices[paisRecibe].ask, commission);
                resultado = cantidadEnvio / tasaConversion;
            }

            const fiatSymbol = fiatSymbols[paisRecibe];
            const formattedResult = new Intl.NumberFormat('es-ES', { 
                style: 'currency', 
                currency: fiatSymbol,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(resultado);
            
            document.getElementById("resultado-remesa").innerText = `Dinero a recibir: ${formattedResult}`;
        }

        function copiarResultado() {
            const resultado = document.getElementById("resultado-remesa").innerText.split(":")[1].trim();
            navigator.clipboard.writeText(resultado).then(() => {
                alert("Resultado copiado al portapapeles!");
            });
        }

        async function exportTableAsImage() {
            const exportBtn = document.getElementById('exportBtn');
            const originalText = exportBtn.innerHTML;
            
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = 'üì∏ Exportando...';
                
                const table = document.getElementById('conversionTable');
                const commission = document.getElementById('commissionInput').value;
                const timestamp = new Date().toLocaleString('es-ES');
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const padding = 40;
                const cellWidth = 120;
                const cellHeight = 40;
                const headerHeight = 50;
                const titleHeight = 60;
                const footerHeight = 40;
                
                const rows = table.rows.length;
                const cols = table.rows[0].cells.length;
                
                canvas.width = cols * cellWidth + padding * 2;
                canvas.height = titleHeight + headerHeight + (rows - 1) * cellHeight + footerHeight + padding * 2;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#333333';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Mandareal Exchange - Tasas de Conversi√≥n', canvas.width / 2, padding + 30);
                
                ctx.font = '16px Arial';
                ctx.fillText(`Comisi√≥n: ${commission}% | ${timestamp}`, canvas.width / 2, padding + 55);
                
                let y = padding + titleHeight;
                
                for (let i = 0; i < rows; i++) {
                    const row = table.rows[i];
                    let x = padding;
                    
                    for (let j = 0; j < cols; j++) {
                        const cell = row.cells[j];
                        const cellText = cell.textContent.trim();
                        
                        if (i === 0) {
                            ctx.fillStyle = '#4CAF50';
                            ctx.fillRect(x, y, cellWidth, headerHeight);
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 14px Arial';
                        } else {
                            if (cell.classList.contains('gray-cell')) {
                                ctx.fillStyle = '#d3d3d3';
                            } else {
                                ctx.fillStyle = '#f9f9f9';
                            }
                            ctx.fillRect(x, y, cellWidth, cellHeight);
                            ctx.fillStyle = '#333333';
                            ctx.font = '12px Arial';
                        }
                        
                        ctx.strokeStyle = '#ddd';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, cellWidth, i === 0 ? headerHeight : cellHeight);
                        
                        ctx.textAlign = 'center';
                        const textY = y + (i === 0 ? headerHeight / 2 + 5 : cellHeight / 2 + 4);
                        
                        if (cellText.length > 10) {
                            ctx.font = '10px Arial';
                        }
                        
                        ctx.fillText(cellText, x + cellWidth / 2, textY);
                        
                        x += cellWidth;
                    }
                    
                    y += i === 0 ? headerHeight : cellHeight;
                }
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mandareal-tasas-${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalText;
                }, 'image/png');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al exportar la tabla. Por favor, int√©ntalo de nuevo.');
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }

        // Event listeners
        document.getElementById('commissionInput').addEventListener('input', updateCommissionSelect);

        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBjb25zb2xlLmxvZygnU2VydmljZSBXb3JrZXIgaW5zdGFsYWRvJyk7CiAgc2VsZi5za2lwV2FpdGluZygpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignYWN0aXZhdGUnLCBmdW5jdGlvbihldmVudCkgewogIGNvbnNvbGUubG9nKCdTZXJ2aWNlIFdvcmtlciBhY3RpdmFkbycpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBmdW5jdGlvbihldmVudCkgewogIGV2ZW50LnJlc3BvbmRXaXRoKGZldGNoKGV2ZW50LnJlcXVlc3QpKTsKfSk7')
                .then(registration => {
                    console.log('‚úÖ Service Worker registrado exitosamente');
                })
                .catch(error => {
                    console.log('‚ùå Error al registrar Service Worker:', error);
                });
        }

        // Detectar si se puede instalar la PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'üì± Instalar App';
            installBtn.className = 'update-btn';
            installBtn.style.backgroundColor = '#9C27B0';
            installBtn.onclick = installApp;
            
            document.querySelector('.commission-row').appendChild(installBtn);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ Usuario instal√≥ la PWA');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Inicializaci√≥n autom√°tica de precios de mercado
        function initializeMarketPrices() {
            console.log('üöÄ Inicializando con precios de mercado...');
            
            Object.keys(API_URLS).forEach(country => {
                const fiat = API_URLS[country].fiat;
                prices[country] = getMarketPrice(fiat);
            });
            
            // Actualizar tabla inmediatamente
            buildConversionTableFromCache();
        }

        function buildConversionTableFromCache() {
            const commission = parseFloat(document.getElementById('commissionInput').value);
            const tableAPIBody = document.getElementById('priceTableAPIBody');
            const tableResultsBody = document.getElementById('priceTableResultsBody');
            
            // Limpiar tablas
            tableAPIBody.innerHTML = '';
            tableResultsBody.innerHTML = '';

            // Poblar tabla de precios
            Object.keys(API_URLS).forEach(country => {
                if (prices[country]) {
                    const newRow = tableAPIBody.insertRow();
                    newRow.innerHTML = `
                        <td>${API_URLS[country].name}</td>
                        <td>${prices[country].bid.toFixed(2)}</td>
                        <td>${prices[country].ask.toFixed(2)}</td>
                        <td style="font-size: 12px; color: #666;">${prices[country].source}</td>
                    `;
                }
            });

            // Poblar tabla de conversiones
            const countries = Object.keys(API_URLS);
            for (const buyerCountry of countries) {
                let rowResults = `<tr><td>${API_URLS[buyerCountry].name}</td>`;

                for (const sellerCountry of countries) {
                    let conversionRate = "--";
                    let cellClass = "";

                    if (buyerCountry !== sellerCountry) {
                        if (prices[buyerCountry] && prices[sellerCountry]) {
                            if (buyerCountry === "colombia" && sellerCountry === "venezuela") {
                                conversionRate = calculateColombiaConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            } else if (sellerCountry === "venezuela") {
                                conversionRate = calculateConversion(
                                    prices[sellerCountry].ask,
                                    prices[buyerCountry].bid,
                                    commission
                                ).toFixed(5);
                            } else {
                                conversionRate = calculateCrossConversion(
                                    prices[buyerCountry].bid,
                                    prices[sellerCountry].ask,
                                    commission
                                ).toFixed(5);
                            }
                        }
                    } else {
                        cellClass = "gray-cell";
                    }

                    rowResults += `<td class="${cellClass}">${conversionRate}</td>`;
                }

                rowResults += '</tr>';
                tableResultsBody.innerHTML += rowResults;
            }
            
            updateLastUpdateTime();
        }

        window.onload = function () {
            console.log('üéØ Iniciando Mandareal Exchange...');
            
            // Inicializar inmediatamente con precios de mercado
            initializeMarketPrices();
            actualizarSelectores();
            updateCommissionFromSelect();
            
            // Intentar actualizar con datos reales en segundo plano
            setTimeout(() => {
                console.log('üîÑ Intentando actualizar con datos P2P en vivo...');
                buildConversionTable();
            }, 3000);
            
            console.log('‚úÖ Aplicaci√≥n lista. Revisa la consola para ver el estado de las fuentes P2P.');
        };
    </script>
</body>
</html>
